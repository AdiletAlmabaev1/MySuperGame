<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –ú–µ—Ç–∞-—Ç–µ–≥ –¥–ª—è –º–æ–±–∏–ª–æ–∫: —É–±–∏—Ä–∞–µ—Ç –∑—É–º –∏ —Å–∫—Ä–æ–ª–ª -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* –°—Ç–∏–ª—å "–ö–∏–±–µ—Ä–ø–∞–Ω–∫/–¢—ë–º–Ω—ã–π" */
        body {
            margin: 0; overflow: hidden; background: #1a1a1a;
            color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif;
            touch-action: none; /* –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞ –ø–∞–ª—å—Ü–∞–º–∏ */
        }
        
        /* –°–ª–æ–∏ (–≠–∫—Ä–∞–Ω—ã) */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.95); z-index: 20; transition: opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
        h1 { color: #00ffcc; text-transform: uppercase; letter-spacing: 2px; text-align: center; font-size: 1.5rem; }
        button {
            background: #ff0055; color: white; border: none; padding: 15px 30px;
            font-size: 1.2rem; margin: 10px; border-radius: 10px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255,0,85,0.4); width: 250px;
        }
        button:active { transform: scale(0.96); }
        .btn-secondary { background: #444; box-shadow: none; }
        
        input {
            padding: 12px; font-size: 1.1rem; border-radius: 5px;
            border: 2px solid #555; background: #222; color: white; text-align: center;
            width: 250px; margin-bottom: 15px;
        }

        /* –ò–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #gameHUD { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #topBar {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            display: flex; justify-content: space-between;
            font-weight: bold; font-size: 1.2rem; background: rgba(0,0,0,0.5);
        }
        
        canvas { display: block; background: #2a2a2a; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–î–∂–æ–π—Å—Ç–∏–∫–∏) */
        #controls {
            position: absolute; bottom: 20px; width: 100%; height: 140px;
            display: flex; justify-content: space-between; pxadding: 0 40px; pointer-events: none;
        }
        .joy-area {
            width: 120px; height: 120px; margin: 0 30px; pointer-events: auto;
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%; position: relative;
        }
        .stick {
            width: 50px; height: 50px; background: rgba(0, 255, 204, 0.5);
            border-radius: 50%; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); box-shadow: 0 0 10px rgba(0,255,204,0.3);
        }
        .shoot-stick .stick { background: rgba(255, 0, 85, 0.6); }

    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="screen-menu" class="screen">
        <h1>–°–±–æ—Ä–Ω–∏–∫ –ò–≥—Ä</h1>
        <button onclick="GameApp.startHost()">üéÆ –°–æ–∑–¥–∞—Ç—å –ò–≥—Ä—É</button>
        <button onclick="GameApp.toLobby()" class="btn-secondary">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <div style="margin-top:20px; font-size: 0.8rem; color: #777;">–ù—É–∂–µ–Ω –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –õ–û–ë–ë–ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø -->
    <div id="screen-lobby" class="screen hidden">
        <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h1>
        <input type="text" id="joinIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –•–æ—Å—Ç–∞" autocomplete="off">
        <button onclick="GameApp.joinGame()">–í–æ–π—Ç–∏</button>
        <button onclick="location.reload()" class="btn-secondary">–ù–∞–∑–∞–¥</button>
        <p id="myIdDisplay" style="color: #ffff00; user-select: text;"></p>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –í–´–ë–û–† –ò–ì–†–´ (–¢–æ–ª—å–∫–æ –¥–ª—è –•–æ—Å—Ç–∞) -->
    <div id="screen-selector" class="screen hidden">
        <h1>–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É</h1>
        <button onclick="GameApp.selectMode('shooter')">üî´ –¢–∞–Ω–∫–∏/–®—É—Ç–µ—Ä</button>
        <button onclick="GameApp.selectMode('clash')" style="background: #4488ff;">üè∞ –ë–∏—Ç–≤–∞ –ó–∞–º–∫–æ–≤</button>
        <div id="waitingMsg"></div>
    </div>

    <!-- –≠–ö–†–ê–ù 4: –°–ê–ú–ê –ò–ì–†–ê -->
    <div id="gameUI" class="hidden">
        <canvas id="ctx"></canvas>
        <div id="gameHUD">
            <div id="topBar">
                <span style="color:#0f0">–ò–≥—Ä–æ–∫ 1: <span id="s1">0</span></span>
                <span style="color:#f05">–ò–≥—Ä–æ–∫ 2: <span id="s2">0</span></span>
            </div>
            <div id="controls">
                <!-- –õ–µ–≤—ã–π —Å—Ç–∏–∫ (—Ö–æ–¥—å–±–∞) -->
                <div class="joy-area" id="joyL"><div class="stick"></div></div>
                <!-- –ü—Ä–∞–≤—ã–π —Å—Ç–∏–∫ (—Å—Ç—Ä–µ–ª—å–±–∞) -->
                <div class="joy-area shoot-stick" id="joyR"><div class="stick"></div></div>
            </div>
        </div>
    </div>

<script>
/**
 * –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–í–ò–ñ–û–ö
 */
const App = {
    mode: null,      // 'shooter', 'clash'
    role: null,      // 'host' –∏–ª–∏ 'client'
    conn: null,      // PeerJS connection
    peer: null,
    canvas: document.getElementById('ctx'),
    ctx: document.getElementById('ctx').getContext('2d'),
    width: 0, height: 0
};

// --- –°–ï–¢–ï–í–û–ô –ü–†–û–¢–û–ö–û–õ ---
const GameApp = {
    startHost: () => {
        App.role = 'host';
        document.querySelector('button').innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID...";
        App.peer = new Peer(); // –°–æ–∑–¥–∞–µ–º —Å–µ–±—è –≤ —Å–µ—Ç–∏ PeerJS
        
        App.peer.on('open', id => {
            // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —ç–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞
            UI.show('screen-selector');
            document.getElementById('waitingMsg').innerHTML = 
                `–¢–≤–æ–π ID: <br><b style="font-size:2rem;color:#0f0">${id}</b><br>–°–æ–æ–±—â–∏ –µ–≥–æ –≤—Ç–æ—Ä–æ–º—É –∏–≥—Ä–æ–∫—É!`;
        });

        App.peer.on('connection', c => {
            App.conn = c;
            GameApp.setupConnection();
            alert("–ò–≥—Ä–æ–∫ 2 –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è! –í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É.");
        });
    },

    toLobby: () => UI.show('screen-lobby'),

    joinGame: () => {
        const id = document.getElementById('joinIdInput').value;
        if (!id) return alert('–í–≤–µ–¥–∏—Ç–µ ID!');
        App.role = 'client';
        App.peer = new Peer();
        App.peer.on('open', myId => {
            App.conn = App.peer.connect(id);
            GameApp.setupConnection();
            document.querySelector('#screen-lobby h1').innerText = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
        });
        App.peer.on('error', err => alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + err));
    },

    setupConnection: () => {
        // –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•
        App.conn.on('data', data => {
            if (data.type === 'START_GAME') {
                App.mode = data.mode;
                startGame();
            }
            if (data.type === 'UPDATE' && App.role === 'client') {
                // –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏—Ä–∞ –∏ —Ä–∏—Å—É–µ—Ç
                Render.world(data.state);
            }
            if (data.type === 'INPUT' && App.role === 'host') {
                // –•–æ—Å—Ç –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞
                Logic.p2Input = data.input;
            }
        });

        App.conn.on('open', () => {
            if (App.role === 'client') {
                 document.querySelector('#screen-lobby h1').innerText = "–ñ–¥–µ–º –≤—ã–±–æ—Ä–∞ –∏–≥—Ä—ã...";
            }
        });
    },

    selectMode: (mode) => {
        if (!App.conn) return alert("–ñ–¥–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
        App.conn.send({ type: 'START_GAME', mode: mode }); // –ö–æ–º–∞–Ω–¥–∞ –∫–ª–∏–µ–Ω—Ç—É
        App.mode = mode;
        startGame();
    }
};

// --- –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ---

// –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let State = {
    p1: { x: 100, y: 300, color: '#00ffcc', score: 0, hp: 100 },
    p2: { x: 800, y: 300, color: '#ff0055', score: 0, hp: 100 },
    bullets: [],
    mobs: [] // –î–ª—è —Ä–µ–∂–∏–º–∞ Clash
};

let Input = { x:0, y:0, sx:0, sy:0, fire:false }; // –ú–æ–π –≤–≤–æ–¥
const Logic = {
    p2Input: { x:0, y:0, sx:0, sy:0, fire:false }, // –í–≤–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
    
    // –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –§–ò–ó–ò–ö–ò (—Ç–æ–ª—å–∫–æ –•–æ—Å—Ç)
    tick: () => {
        const S = 5; // –°–∫–æ—Ä–æ—Å—Ç—å

        // 1. –î–≤–∏–∂–µ–Ω–∏–µ –ò–≥—Ä–æ–∫–∞ 1 (–õ–æ–∫–∞–ª—å–Ω–æ–µ)
        State.p1.x += Input.x * S;
        State.p1.y += Input.y * S;
        
        // 2. –î–≤–∏–∂–µ–Ω–∏–µ –ò–≥—Ä–æ–∫–∞ 2 (–°–µ—Ç–µ–≤–æ–µ)
        State.p2.x += Logic.p2Input.x * S;
        State.p2.y += Logic.p2Input.y * S;

        // –ì—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã
        [State.p1, State.p2].forEach(p => {
            if(p.x < 0) p.x = 0; if(p.x > App.width) p.x = App.width;
            if(p.y < 0) p.y = 0; if(p.y > App.height) p.y = App.height;
        });

        // –õ–û–ì–ò–ö–ê –ó–ê–í–ò–°–ò–¢ –û–¢ –†–ï–ñ–ò–ú–ê
        if(App.mode === 'shooter') Logic.modeShooter();
        else if(App.mode === 'clash') Logic.modeClash();
    },

    modeShooter: () => {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã P1
        if (Input.fire && Frame % 15 === 0) 
            State.bullets.push({x: State.p1.x, y: State.p1.y, vx: Input.sx*15, vy: Input.sy*15, owner:1});
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã P2
        if (Logic.p2Input.fire && Frame % 15 === 0) 
            State.bullets.push({x: State.p2.x, y: State.p2.y, vx: Logic.p2Input.sx*15, vy: Logic.p2Input.sy*15, owner:2});

        // –î–≤–∏–∂–µ–Ω–∏–µ –ø—É–ª—å
        for(let i=State.bullets.length-1; i>=0; i--){
            let b = State.bullets[i];
            b.x += b.vx; b.y += b.vy;
            
            // –£–±–æ—Ä–∫–∞ –ø—É–ª—å –∑–∞ —ç–∫—Ä–∞–Ω–æ–º
            if(b.x < 0 || b.x > App.width || b.y < 0 || b.y > App.height) {
                State.bullets.splice(i,1); continue;
            }

            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ (Hitbox 30px)
            let target = b.owner === 1 ? State.p2 : State.p1;
            let dist = Math.hypot(b.x - target.x, b.y - target.y);
            if(dist < 30) {
                if(b.owner===1) State.p1.score++; else State.p2.score++;
                State.bullets.splice(i,1);
                // "–†–µ—Å–ø–∞—É–Ω" - –ø—Ä–æ—Å—Ç–æ —Ç–æ–ª–∫–∞–µ–º –≤ —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ
                target.x = Math.random() * App.width;
                target.y = Math.random() * App.height;
            }
        }
    },
    
    modeClash: () => {
        // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è: –∫—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–∫—Ä–∞—Å–∏—Ç —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞
        // P1 –∏ P2 –ø—Ä–æ—Å—Ç–æ –±–µ–≥–∞—é—Ç –∏ —Å–æ–±–∏—Ä–∞—é—Ç –º–æ–Ω–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —è —Å–æ–∑–¥–∞–º
        if(Frame % 60 === 0) {
            State.mobs.push({ x: Math.random() * App.width, y: Math.random() * App.height, active: true });
        }
        // –°–±–æ—Ä –º–æ–Ω–µ—Ç
        State.mobs.forEach(m => {
            if(!m.active) return;
            if(Math.hypot(State.p1.x - m.x, State.p1.y - m.y) < 40) { m.active=false; State.p1.score++; }
            if(Math.hypot(State.p2.x - m.x, State.p2.y - m.y) < 40) { m.active=false; State.p2.score++; }
        });
    }
};

let Frame = 0;
function gameLoop() {
    Frame++;
    if(App.role === 'host') {
        Logic.tick();
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É
        App.conn.send({ type: 'UPDATE', state: State });
        Render.world(State);
    } else {
        // –ö–ª–∏–µ–Ω—Ç —à–ª–µ—Ç —Ç–æ–ª—å–∫–æ input
        App.conn.send({ type: 'INPUT', input: Input });
        // (–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–æ–±—ã—Ç–∏–∏ on 'data')
    }
    requestAnimationFrame(gameLoop);
}

function startGame() {
    UI.show('gameUI');
    
    // –†–µ—Å–∞–π–∑ –ø–æ–¥ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
    App.width = window.innerWidth;
    App.height = window.innerHeight;
    App.canvas.width = App.width;
    App.canvas.height = App.height;

    // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    State.p1.x = 100; State.p1.y = App.height/2;
    State.p2.x = App.width-100; State.p2.y = App.height/2;

    gameLoop();
}

// --- –†–ò–°–û–í–ê–ù–ò–ï ---
const Render = {
    world: (state) => {
        const ctx = App.ctx;
        ctx.fillStyle = '#1a1a1a'; // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ–Ω–∞
        ctx.fillRect(0, 0, App.width, App.height);

        // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i=0; i<App.width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i, App.height); }
        for(let i=0; i<App.height; i+=100) { ctx.moveTo(0,i); ctx.lineTo(App.width, i); }
        ctx.stroke();

        // –†–∏—Å—É–µ–º –º–æ–Ω–µ—Ç–∫–∏ (–¥–ª—è Clash —Ä–µ–∂–∏–º–∞)
        if(App.mode === 'clash') {
            ctx.fillStyle = 'gold';
            state.mobs.forEach(m => {
                if(m.active) {
                    ctx.beginPath(); ctx.arc(m.x, m.y, 10, 0, Math.PI*2); ctx.fill();
                }
            });
        }

        // –ò–≥—Ä–æ–∫–∏
        Render.player(state.p1, "P1");
        Render.player(state.p2, "P2");

        // –ü—É–ª–∏
        ctx.fillStyle = '#ffaa00';
        state.bullets.forEach(b => {
            ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill();
        });

        // UI –°—á–µ—Ç–∞
        document.getElementById('s1').innerText = state.p1.score;
        document.getElementById('s2').innerText = state.p2.score;
    },
    player: (p, label) => {
        const ctx = App.ctx;
        ctx.fillStyle = p.color;
        // –¢–∞–Ω—á–∏–∫/–ü–µ—Ä—Å–æ–Ω–∞–∂ (–ö—Ä—É–≥ + –ü—É—à–∫–∞)
        ctx.beginPath(); ctx.arc(p.x, p.y, 25, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = '#fff';
        ctx.font = '20px Arial';
        ctx.fillText(label, p.x - 10, p.y - 40);
    }
};

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï (TOUCH + KEYBOARD) ---
const UI = {
    show: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'gameUI') document.getElementById('gameUI').classList.remove('hidden');
    }
};

// –î–∂–æ–π—Å—Ç–∏–∫–∏
setupJoystick('joyL', (d) => { Input.x = d.x; Input.y = d.y; });
setupJoystick('joyR', (d) => { Input.sx = d.x; Input.sy = d.y; Input.fire = (d.x||d.y); });

function setupJoystick(elemId, callback) {
    const zone = document.getElementById(elemId);
    const stick = zone.querySelector('.stick');
    let drag = false;
    let touchId = null;
    let rect = zone.getBoundingClientRect();

    function move(cx, cy) {
        const center = 60; // radius of area
        let dx = cx - (rect.left + center);
        let dy = cy - (rect.top + center);
        let dist = Math.min(Math.hypot(dx,dy), 50);
        let angle = Math.atan2(dy, dx);
        
        let tx = Math.cos(angle) * dist;
        let ty = Math.sin(angle) * dist;
        stick.style.transform = `translate(-50%, -50%) translate(${tx}px, ${ty}px)`;
        callback({x: tx/50, y: ty/50});
    }

    zone.addEventListener('touchstart', e => {
        e.preventDefault(); drag = true; 
        rect = zone.getBoundingClientRect(); // re-calc coords
        touchId = e.changedTouches[0].identifier;
        move(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    });
    
    zone.addEventListener('touchmove', e => {
        if(!drag) return;
        e.preventDefault();
        for(let t of e.changedTouches) {
            if(t.identifier === touchId) move(t.clientX, t.clientY);
        }
    });

    const reset = () => { 
        drag=false; 
        stick.style.transform = `translate(-50%, -50%)`; 
        callback({x:0, y:0}); 
    };
    zone.addEventListener('touchend', reset);
}

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –ü–ö)
window.addEventListener('keydown', e => {
    if(e.key==='w') Input.y = -1;
    if(e.key==='s') Input.y = 1;
    if(e.key==='a') Input.x = -1;
    if(e.key==='d') Input.x = 1;
    if(e.key==='ArrowUp') { Input.sy=-1; Input.fire=true; }
    if(e.key==='ArrowDown') { Input.sy=1; Input.fire=true; }
    if(e.key==='ArrowLeft') { Input.sx=-1; Input.fire=true; }
    if(e.key==='ArrowRight') { Input.sx=1; Input.fire=true; }
});
window.addEventListener('keyup', e => {
    if('ws'.includes(e.key)) Input.y = 0;
    if('ad'.includes(e.key)) Input.x = 0;
    if(['ArrowUp','ArrowDown'].includes(e.key)) Input.sy = 0;
    if(['ArrowLeft','ArrowRight'].includes(e.key)) Input.sx = 0;
    if(Input.sx===0 && Input.sy===0) Input.fire = false;
});
</script>
</body>
</html>