<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Battle Multi</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* CSS: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –°—Ç–∏–ª—å */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; overflow: hidden; background: #050505; color: #fff; 
            font-family: 'Orbitron', sans-serif; touch-action: none;
        }

        .screen {
            position: absolute; width: 100%; height: 100%; background: #050505;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; transition: opacity 0.5s;
        }
        .hidden { display: none !important; }

        h1 { font-size: 2.5rem; text-shadow: 0 0 20px #0ff; margin-bottom: 40px; text-align: center; }
        
        button {
            background: linear-gradient(45deg, #00f, #f0f); border: none; padding: 20px 40px;
            font-family: 'Orbitron', sans-serif; color: white; font-size: 1.2rem;
            margin: 10px; border-radius: 5px; box-shadow: 0 0 15px #00f; cursor: pointer;
            width: 80%; max-width: 300px; text-transform: uppercase;
        }
        button:active { transform: scale(0.95); box-shadow: 0 0 5px #00f; }
        input { 
            padding: 15px; font-size: 1.2rem; background: #111; border: 1px solid #0ff; 
            color: #0ff; text-align: center; width: 80%; margin-bottom: 20px; font-family: 'Orbitron';
        }

        /* –ò–ì–†–û–í–û–ô UI */
        canvas { display: block; }
        
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        }
        .top-bar {
            display: flex; justify-content: space-between; padding: 15px; 
            font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px #000;
        }
        
        /* –°—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –®—É—Ç–µ—Ä–∞) */
        #sticks-layer { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; }
        .stick-zone { width: 100px; height: 100px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: auto; }
        .stick-knob { width: 40px; height: 40px; background: rgba(0,255,255,0.5); border-radius: 50%; position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Clash) */
        #cards-layer {
            position: absolute; bottom: 10px; width: 100%; display: flex; 
            justify-content: center; pointer-events: auto; gap: 10px;
        }
        .card-btn {
            width: 70px; height: 90px; background: #222; border: 2px solid #555; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            cursor: pointer; position: relative; pointer-events: auto;
        }
        .card-btn.ready { border-color: #0f0; box-shadow: 0 0 10px #0f0; background: #002200; }
        .card-cost { position: absolute; top:-10px; right:-10px; background: #a0f; border-radius: 50%; width: 25px; height: 25px; display:flex; justify-content:center; align-items:center; font-size: 0.8rem; }
        .elixir-bar-bg {
            position: absolute; bottom: 110px; left: 10%; width: 80%; height: 10px; background: #333; border:1px solid white;
        }
        .elixir-fill { height: 100%; background: #d0f; width: 0%; transition: width 0.2s; }
        
    </style>
</head>
<body>

    <!-- –ú–µ–Ω—é -->
    <div id="screen-menu" class="screen">
        <h1>NEON VERSUS</h1>
        <button onclick="Game.startHost()">‚ö° HOST GAME</button>
        <button onclick="UI.show('screen-lobby')" style="background:linear-gradient(45deg,#444,#666)">üîó JOIN GAME</button>
    </div>

    <!-- –õ–æ–º–º–∏ -->
    <div id="screen-lobby" class="screen hidden">
        <h1>Connect</h1>
        <input type="text" id="joinId" placeholder="HOST ID">
        <button onclick="Game.joinGame()">GO</button>
        <button onclick="UI.show('screen-menu')" style="background:#333">Back</button>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (–•–æ—Å—Ç) -->
    <div id="screen-mode" class="screen hidden">
        <h1>Select Mode</h1>
        <button onclick="Game.selectMode('tanks')">üöú Neon Tanks</button>
        <button onclick="Game.selectMode('clash')">‚öîÔ∏è Cyber Clash</button>
        <div id="host-msg" style="color:#aaa; margin-top:20px; font-size:0.9rem">Wait for player 2...</div>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="screen-game" class="screen hidden">
        <canvas id="ctx"></canvas>
        <div id="hud">
            <div class="top-bar">
                <span style="color:#0ff">P1: <span id="score1">0</span></span>
                <span style="color:#f0f">P2: <span id="score2">0</span></span>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–∞–Ω–∫–æ–≤ -->
            <div id="sticks-layer" class="hidden">
                <div class="stick-zone" id="joyL"><div class="stick-knob"></div></div>
                <div class="stick-zone" id="joyR" style="border-color: rgba(255,0,255,0.2)"><div class="stick-knob" style="background:rgba(255,0,255,0.5)"></div></div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è Clash -->
            <div id="elixir-ui" class="hidden">
                <div class="elixir-bar-bg"><div class="elixir-fill" id="e-fill"></div></div>
            </div>
            <div id="cards-layer" class="hidden">
                <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è JS-–æ–º -->
            </div>
        </div>
    </div>
<script>
// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –°–ö–†–ò–ü–¢–ê –° –í–´–í–û–î–û–ú –û–®–ò–ë–û–ö ---

// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
const COLORS = { p1: '#00ffff', p2: '#ff00ff', wall: '#ffffff' };

const Game = {
    role: null, conn: null, peer: null, mode: null,
    width: 0, height: 0, 
    loopId: null,

    startHost: () => {
        Game.role = 'host';
        const btn = document.querySelector('button');
        btn.innerText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
        
        // –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Peer
        try {
            Game.peer = new Peer({ debug: 2 });
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Peer: " + e); }

        Game.peer.on('open', id => {
            UI.show('screen-mode');
            document.getElementById('host-msg').innerHTML = 
                `–í–∞—à ID: <b style="color:#fff;font-size:1.5rem">${id}</b><br>–ü–µ—Ä–µ–¥–∞–π—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É!`;
        });
        
        // –í–´–í–û–î –û–®–ò–ë–û–ö –ù–ê –≠–ö–†–ê–ù
        Game.peer.on('error', (err) => {
            alert("–û–®–ò–ë–ö–ê –°–ï–¢–ò: " + err.type + "\n" + err);
            btn.innerText = '–û—à–∏–±–∫–∞ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ VPN)';
        });

        Game.peer.on('connection', c => {
            Game.conn = c;
            Game.setupConn();
            alert("–ò–≥—Ä–æ–∫ 2 –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!");
        });
    },

    joinGame: () => {
        const id = document.getElementById('joinId').value;
        if(!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID —Ö–æ—Å—Ç–∞");
        
        Game.role = 'client';
        try {
            Game.peer = new Peer();
        } catch(e) { alert("–û—à–∏–±–∫–∞ Peer: " + e); }

        Game.peer.on('error', err => alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: " + err));

        Game.peer.on('open', myId => {
            Game.conn = Game.peer.connect(id);
            if(!Game.conn) { alert("–ù–µ–≤–µ—Ä–Ω—ã–π ID –∏–ª–∏ —Ö–æ—Å—Ç –æ—Ñ—Ñ–ª–∞–π–Ω"); return; }
            Game.setupConn();
        });
    },

    setupConn: () => {
        Game.conn.on('open', () => {
             console.log("Connected!");
        });
        Game.conn.on('data', d => {
            if(d.type === 'START') Game.initGame(d.mode);
            if(d.type === 'WORLD') { Renderer.state = d.state; if(Game.role==='client') Renderer.draw(); }
            if(d.type === 'INPUT' && Game.role==='host') Logic.p2Input = d.input;
        });
        Game.conn.on('close', () => alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ!"));
    },

    selectMode: (m) => {
        if(!Game.conn || !Game.conn.open) return alert("–ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...");
        Game.conn.send({type:'START', mode:m});
        Game.initGame(m);
    },

    initGame: (m) => {
        Game.mode = m;
        UI.show('screen-game');
        const c = document.getElementById('ctx');
        Game.width = window.innerWidth;
        Game.height = window.innerHeight;
        c.width = Game.width; c.height = Game.height;

        document.getElementById('sticks-layer').classList.toggle('hidden', m !== 'tanks');
        document.getElementById('cards-layer').classList.toggle('hidden', m !== 'clash');
        document.getElementById('elixir-ui').classList.toggle('hidden', m !== 'clash');
        
        if(m === 'clash') ClashLogic.initUI();
        Logic.reset();
        if(Game.role === 'host') Game.loop();
    },

    loop: () => {
        Logic.update();
        if(Game.conn && Game.conn.open) {
            Game.conn.send({type:'WORLD', state: Logic.state});
        }
        Renderer.state = Logic.state; 
        Renderer.draw();
        Game.loopId = requestAnimationFrame(Game.loop);
    }
};

// --- –§–ò–ó–ò–ö–ê (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –û–°–¢–ê–í–ò–õ –ë–ê–ó–û–í–£–Æ) ---
const Logic = {
    state: {},
    p1Input: {x:0, y:0, aimX:0, aimY:0, shoot:false, spawn: null},
    p2Input: {x:0, y:0, aimX:0, aimY:0, shoot:false, spawn: null},
    reset: () => {
        Logic.state = {
            tanks: [ {x: 100, y: Game.height/2, hp:100, cd:0, score:0}, {x: Game.width-100, y: Game.height/2, hp:100, cd:0, score:0} ],
            bullets: [], walls: [], units: [], elixir: { p1: 0, p2: 0 }, mode: Game.mode, time: 0
        };
        if(Game.mode === 'tanks') {
            for(let i=0; i<8; i++) Logic.state.walls.push({x: Math.random()*Game.width, y: Math.random()*Game.height, w: 20, h: 100});
        }
    },
    update: () => {
        Logic.state.time++;
        if(Logic.state.mode === 'tanks') TanksLogic.tick(); else ClashLogic.tick();
    }
};

const TanksLogic = {
    tick: () => {
        const s = Logic.state; const sp = 4;
        const p1 = s.tanks[0]; p1.x += Logic.p1Input.x * sp; p1.y += Logic.p1Input.y * sp;
        const p2 = s.tanks[1]; p2.x += Logic.p2Input.x * sp; p2.y += Logic.p2Input.y * sp;
        
        [Logic.p1Input, Logic.p2Input].forEach((inp, i) => {
            let t = s.tanks[i];
            if(inp.shoot && t.cd <= 0) {
                s.bullets.push({x:t.x, y:t.y, vx:inp.aimX*15, vy:inp.aimY*15, o:i}); t.cd = 20;
            }
            if(t.cd>0) t.cd--;
        });
        
        for(let i=s.bullets.length-1; i>=0; i--) {
            let b = s.bullets[i]; b.x+=b.vx; b.y+=b.vy;
            let target = s.tanks[b.o === 0 ? 1 : 0];
            if(Math.hypot(b.x-target.x, b.y-target.y) < 30) {
                s.tanks[b.o].score++; b.x = -1000;
            }
        }
    }
};

const ClashLogic = {
    cards: [{name:'Tank', cost:3, hp:200}, {name:'Run', cost:2, hp:50}],
    initUI: () => {
        const c = document.getElementById('cards-layer'); c.innerHTML='';
        ClashLogic.cards.forEach((k,i)=>{
            let b=document.createElement('div'); b.className='card-btn'; 
            b.innerHTML=`<b>${k.cost}</b>${k.name}`;
            b.onclick=()=>Logic.p1Input.spawn=i; c.appendChild(b);
        });
    },
    tick: () => { /* –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ clash –¥–ª—è —Ç–µ—Å—Ç–∞ */
        const s = Logic.state; 
        if(s.time%60===0) { s.elixir.p1++; s.elixir.p2++; }
        
        if(Logic.p1Input.spawn!==null && s.elixir.p1 >= ClashLogic.cards[Logic.p1Input.spawn].cost) {
             s.units.push({x:50, y:200+Math.random()*300, owner:0, c:'#0ff'}); 
             s.elixir.p1-=ClashLogic.cards[Logic.p1Input.spawn].cost; 
             Logic.p1Input.spawn=null;
        }
        // AI –¥–≤–∏–∂–µ–Ω–∏–µ
        s.units.forEach(u => u.x += (u.owner===0?2:-2));
    }
};

// --- DRAW ---
const Renderer = {
    state: null,
    draw: () => {
        if(!Renderer.state) return;
        const ctx = document.getElementById('ctx').getContext('2d');
        const s = Renderer.state;
        ctx.fillStyle='#050505'; ctx.fillRect(0,0,Game.width,Game.height);
        
        if(s.mode === 'tanks') {
             ctx.fillStyle='#fff'; s.walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));
             Renderer.drawP(s.tanks[0], COLORS.p1); Renderer.drawP(s.tanks[1], COLORS.p2);
             ctx.fillStyle='orange'; s.bullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,5,0,7);ctx.fill()});
        } else {
             ctx.fillStyle=COLORS.p1; s.units.forEach(u=>{ctx.beginPath();ctx.arc(u.x,u.y,10,0,7);ctx.fill()});
             document.getElementById('e-fill').style.width = (s.elixir.p1*10)+'%';
        }
        document.getElementById('score1').innerText = s.tanks[0].score;
        document.getElementById('score2').innerText = s.tanks[1].score;
    },
    drawP: (p,c) => { ctx=document.getElementById('ctx').getContext('2d'); ctx.fillStyle=c; ctx.fillRect(p.x-20,p.y-20,40,40); }
};

// UI UTILS
const UI = { show: (id) => { document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }};

// JOYSTICKS
function setupJoy(id,cb) {
    const el=document.getElementById(id); 
    el.addEventListener('touchmove',e=>{ e.preventDefault(); 
        let rect=el.getBoundingClientRect(); 
        let t=e.touches[0]; 
        let dx=(t.clientX-rect.left-50)/50; let dy=(t.clientY-rect.top-50)/50;
        el.querySelector('div').style.transform=`translate(${dx*25}px,${dy*25}px)`;
        cb(dx, dy); 
    });
    el.addEventListener('touchend', ()=>{ el.querySelector('div').style.transform='none'; cb(0,0); });
}
setupJoy('joyL', (x,y)=>Logic.p1Input.x=x?x:Logic.p1Input.y=y); // Quick hack binding
setupJoy('joyR', (x,y)=>{Logic.p1Input.aimX=x; Logic.p1Input.aimY=y; Logic.p1Input.shoot=(Math.abs(x)+Math.abs(y)>0.5)});

window.sendInp = function() { /* –ü—É—Å—Ç—ã—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */ };
</body>
</html>
</script>
