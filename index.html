<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple PvP</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; color: white; font-family: monospace; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; }
        input { background: #333; border: 1px solid #555; color: white; padding: 5px; }
        button { cursor: pointer; padding: 5px 10px; background: #444; color: #fff; border: 1px solid #666; }
        button:hover { background: #666; }
    </style>
</head>
<body>

<!-- Интерфейс -->
<div id="ui">
    <div id="status">Статус: Ожидание...</div>
    <div style="margin-top: 10px;">
        <p>Ваш ID: <input id="my-id" readonly onclick="this.select()"></p>
        <p>ID друга: <input id="friend-id"></p>
        <button onclick="Net.connect()">Подключиться</button>
    </div>
    <p style="font-size: 0.8em; color: #aaa;">Управление: WASD + Клик</p>
</div>

<canvas id="game"></canvas>

<script>
// === 1. НАСТРОЙКИ И СОСТОЯНИЕ ===
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
cvs.width = window.innerWidth; cvs.height = window.innerHeight;

// Состояние игры
const Game = {
    me:  { x: 100, y: 100, hp: 100, color: '#00f3ff' }, // Я (Синий)
    opp: { x: 300, y: 100, hp: 100, color: '#ff0055' }, // Враг (Красный)
    bullets: [], // Пули {x, y, vx, vy, owner}
    keys: {},    // Нажатые кнопки
    mouse: { x:0, y:0, down: false }
};

// === 2. СЕТЬ (PEERJS) ===
const Net = {
    peer: new Peer(),
    conn: null,
    isHost: false,

    init: () => {
        // При получении своего ID
        Net.peer.on('open', id => {
            document.getElementById('my-id').value = id;
            document.getElementById('status').innerText = "Готов. Скопируй свой ID или вставь ID друга.";
        });

        // Если к нам подключились
        Net.peer.on('connection', conn => {
            Net.conn = conn;
            Net.isHost = true;
            Net.setup();
            document.getElementById('status').innerText = "Игрок подключен! (Вы Хост)";
        });
    },

    connect: () => {
        const id = document.getElementById('friend-id').value;
        if(!id) return alert("Введите ID!");
        Net.conn = Net.peer.connect(id);
        Net.setup();
        document.getElementById('status').innerText = "Подключено к хосту!";
    },

    setup: () => {
        // Обработка входящих данных
        Net.conn.on('data', data => {
            // Синхронизируем врага (для меня Opp - это тот, кто прислал данные)
            Game.opp.x = data.x;
            Game.opp.y = data.y;
            Game.opp.hp = data.hp;
            
            // Если пришел выстрел
            if(data.shoot) {
                spawnBullet(Game.opp.x, Game.opp.y, data.shoot.x, data.shoot.y, 'enemy');
            }
        });
    },

    // Отправка своих данных врагу
    send: (packet) => {
        if(Net.conn && Net.conn.open) Net.conn.send(packet);
    }
};

Net.init();

// === 3. ИГРОВАЯ ЛОГИКА ===
function update() {
    // 1. Движение (WASD)
    const speed = 4;
    if(Game.keys['KeyW']) Game.me.y -= speed;
    if(Game.keys['KeyS']) Game.me.y += speed;
    if(Game.keys['KeyA']) Game.me.x -= speed;
    if(Game.keys['KeyD']) Game.me.x += speed;

    // 2. Стрельба (Клик)
    let shotData = null;
    if(Game.mouse.down) {
        Game.mouse.down = false; // Сброс клика
        // Создаем пулю локально
        spawnBullet(Game.me.x, Game.me.y, Game.mouse.x, Game.mouse.y, 'me');
        // Запоминаем куда стреляли для отправки
        shotData = { x: Game.mouse.x, y: Game.mouse.y };
    }

    // 3. Обновление пуль
    for(let i = Game.bullets.length - 1; i >= 0; i--) {
        let b = Game.bullets[i];
        b.x += b.vx;
        b.y += b.vy;

        // Попадание в меня (если пуля вражеская)
        if(b.owner === 'enemy' && Math.hypot(b.x - Game.me.x, b.y - Game.me.y) < 20) {
            Game.me.hp -= 10;
            Game.bullets.splice(i, 1);
            continue;
        }
        
        // Удаление, если улетела далеко
        if(b.x < 0 || b.x > cvs.width || b.y < 0 || b.y > cvs.height) {
            Game.bullets.splice(i, 1);
        }
    }

    // 4. Отправка данных по сети
    if(Net.conn) {
        Net.send({
            x: Game.me.x,
            y: Game.me.y,
            hp: Game.me.hp,
            shoot: shotData // null или координаты выстрела
        });
    }
}

function spawnBullet(sx, sy, tx, ty, owner) {
    const angle = Math.atan2(ty - sy, tx - sx);
    const speed = 10;
    Game.bullets.push({
        x: sx, y: sy,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        owner: owner
    });
}

// === 4. ОТРИСОВКА ===
function draw() {
    // Очистка фона
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, cvs.width, cvs.height);

    // Рисуем игроков
    drawPlayer(Game.me);
    drawPlayer(Game.opp);

    // Рисуем пули
    ctx.fillStyle = '#ffff00';
    Game.bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 5, 0, Math.PI*2);
        ctx.fill();
    });

    requestAnimationFrame(loop);
}

function drawPlayer(p) {
    // Тело
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 20, 0, Math.PI*2);
    ctx.fill();
    
    // HP Бар
    ctx.fillStyle = 'red';
    ctx.fillRect(p.x - 20, p.y - 35, 40, 5);
    ctx.fillStyle = '#0f0';
    ctx.fillRect(p.x - 20, p.y - 35, 40 * (p.hp / 100), 5);
}

// Главный цикл
function loop() {
    update();
    draw();
}

// === 5. УПРАВЛЕНИЕ (Event Listeners) ===
window.addEventListener('keydown', e => Game.keys[e.code] = true);
window.addEventListener('keyup', e => Game.keys[e.code] = false);
window.addEventListener('mousemove', e => { Game.mouse.x = e.clientX; Game.mouse.y = e.clientY; });
window.addEventListener('mousedown', () => Game.mouse.down = true);
window.addEventListener('resize', () => { cvs.width = window.innerWidth; cvs.height = window.innerHeight; });

// Запуск
loop();

</script>
</body>
</html>
