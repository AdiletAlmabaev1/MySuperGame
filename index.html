<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Anime Party (Max 6 Players)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Arial', sans-serif; }
        
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2b1055, #7597de);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .box { 
            background: white; padding: 40px; border-radius: 20px; 
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        h2 { margin: 0; color: #333; }
        .code-box { background: #eee; padding: 10px; margin: 15px 0; font-family: monospace; font-size: 20px; border-radius: 5px; border: 1px dashed #333; }
        button { 
            padding: 12px 30px; font-size: 16px; border: none; border-radius: 30px; 
            cursor: pointer; font-weight: bold; color: white; transition: 0.2s;
        }
        .btn-host { background: #6c5ce7; }
        .btn-join { background: #00cec9; margin-left: 10px; }
        .btn-host:hover { background: #5549b8; }
        
        /* UI */
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; display: none; }
        .stat { color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 20px; }
        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 12px; height: 12px; 
            background: rgba(255, 255, 255, 0.8); border: 2px solid black; 
            border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; display: none;
        }
        
        #players-list { position: absolute; top: 10px; right: 10px; color: yellow; font-family: monospace; text-align: right; font-weight: bold; text-shadow: 1px 1px black; }
    </style>
</head>
<body>

<!-- МЕНЮ -->
<div id="menu">
    <div class="box" id="step1">
        <h2>Anime Battle Royale</h2>
        <p>Выберите роль:</p>
        <button class="btn-host" onclick="Game.initHost()">Я СОЗДАЮ ИГРУ (HOST)</button>
        <br><br>
        <p>Или введите ID друга:</p>
        <input type="text" id="host-id-input" placeholder="ID Хоста" style="padding:10px; width:200px;">
        <button class="btn-join" onclick="Game.joinGame()">ПОДКЛЮЧИТЬСЯ</button>
    </div>

    <div class="box" id="step2-host" style="display:none;">
        <h2>Ожидание игроков...</h2>
        <p>Отправьте этот код друзьям:</p>
        <div class="code-box" id="my-id-display">...</div>
        <p>Подключено игроков: <span id="connected-count">0</span></p>
        <button class="btn-host" onclick="Game.startGameUI()">НАЧАТЬ ИГРУ</button>
    </div>
    
    <div class="box" id="step2-client" style="display:none;">
        <h2>Подключение...</h2>
        <p>Ждем ответа от сервера...</p>
    </div>
</div>

<!-- ИНТЕРФЕЙС -->
<div id="ui-layer">
    <div class="stat">HP: <span id="hp-val">100</span></div>
</div>
<div id="players-list">Players: 1</div>
<div id="crosshair"></div>

<script>
    // === НАСТРОЙКИ ===
    const SETTINGS = {
        colors: [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff], // Цвета разных игроков
        speed: 12,
        syncRate: 50 // мс (обновление 20 раз в сек)
    };

    // === ДАННЫЕ ИГРЫ ===
    const Game = {
        isHost: false,
        myId: null,
        hostConn: null, // Если мы клиент - тут связь с хостом
        clients: {},    // Если мы хост - тут список { id: conn }
        
        // 3D движок
        scene: null, camera: null, renderer: null,
        myObj: null, // Мой персонаж (просто камера и хитбокс)
        players: {}, // Другие игроки: { id: mesh }
        
        inputs: { w:0, a:0, s:0, d:0, yaw:0, pitch:0 },
        isPlaying: false,
        hp: 100
    };

    // === СЕТЕВАЯ ЛОГИКА ===
    const Net = {
        peer: new Peer(),
        
        init: () => {
            Net.peer.on('open', id => {
                Game.myId = id;
                console.log("My ID: " + id);
            });
        },
        
        // Хост принимает гостей
        setupHost: () => {
            document.getElementById('my-id-display').innerText = Game.myId;
            
            Net.peer.on('connection', conn => {
                // Новый игрок подключился
                conn.on('open', () => {
                    console.log("Player joined: " + conn.peer);
                    Game.clients[conn.peer] = conn;
                    Game.addPlayer(conn.peer); // Создаем модельку для него
                    document.getElementById('connected-count').innerText = Object.keys(Game.clients).length;
                    
                    // Хост отправляет новому игроку его "Номер цвета" и состояние мира
                    conn.send({ type: 'welcome', id: conn.peer, colorIdx: Object.keys(Game.clients).length });
                });

                conn.on('data', data => Net.handleData(conn.peer, data));
                conn.on('close', () => Game.removePlayer(conn.peer));
            });
        },

        // Клиент подключается к хосту
        connectToHost: (hostId) => {
            const conn = Net.peer.connect(hostId);
            conn.on('open', () => {
                Game.hostConn = conn;
                document.getElementById('step2-client').innerHTML = "<h2>Готово!</h2><button onclick='Game.startGameUI()'>ВОЙТИ В БОЙ</button>";
            });
            conn.on('data', data => Net.handleClientData(data));
            conn.on('close', () => alert("Связь с сервером потеряна"));
        },

        // Обработка данных НА СЕРВЕРЕ (Хосте)
        handleData: (senderId, data) => {
            if (data.type === 'move') {
                // 1. Обновляем позицию у себя
                Game.updatePlayerPos(senderId, data);
                
                // 2. Рассылаем ЭТУ позицию всем ОСТАЛЬНЫМ (Броадкаст)
                for (let clientId in Game.clients) {
                    if (clientId !== senderId) {
                        Game.clients[clientId].send({
                            type: 'update',
                            id: senderId,
                            x: data.x, y: data.y, z: data.z, yaw: data.yaw
                        });
                    }
                }
            }
            if (data.type === 'shoot') {
                 // Рассылаем всем выстрел
                 const payload = { type: 'shoot', from: senderId };
                 for (let cid in Game.clients) { Game.clients[cid].send(payload); }
            }
        },

        // Обработка данных НА КЛИЕНТЕ
        handleClientData: (data) => {
            if (data.type === 'update') {
                // Хост говорит, где находится другой игрок
                Game.updatePlayerPos(data.id, data);
            }
            else if (data.type === 'welcome') {
                // Нам присвоили цвет
                console.log("Connected as " + data.id);
            }
        }
    };
    Net.init();

    // === УПРАВЛЕНИЕ МЕНЮ ===
    Game.initHost = () => {
        Game.isHost = true;
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2-host').style.display = 'block';
        Net.setupHost();
    };

    Game.joinGame = () => {
        const id = document.getElementById('host-id-input').value;
        if (!id) return alert("Введите ID!");
        Game.isHost = false;
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2-client').style.display = 'block';
        Net.connectToHost(id);
    };

    Game.startGameUI = () => {
        document.getElementById('menu').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        document.getElementById('crosshair').style.display = 'block';
        Game.init3D();
        Game.isPlaying = true;
    };

    // === ИГРОВОЙ ДВИЖОК ===
    Game.init3D = () => {
        Game.scene = new THREE.Scene();
        Game.scene.background = new THREE.Color(0x88ccff);
        Game.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        Game.renderer = new THREE.WebGLRenderer({antialias:true});
        Game.renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(Game.renderer.domElement);
        
        // Пол
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshBasicMaterial({color: 0x333333}));
        floor.rotation.x = -Math.PI/2;
        Game.scene.add(floor);
        Game.scene.add(new THREE.GridHelper(100, 50));
        
        // Свет
        Game.scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        
        // Я (Физический объект не нужен, только координаты)
        Game.myObj = { x: 0, y: 1.6, z: 0 };
        
        // Управление мышкой
        document.body.requestPointerLock = document.body.requestPointerLock || document.body.mozRequestPointerLock;
        document.body.onclick = () => { if(Game.isPlaying) document.body.requestPointerLock(); };
        
        document.addEventListener('mousemove', e => {
            if(document.pointerLockElement === document.body) {
                Game.inputs.yaw -= e.movementX * 0.002;
                Game.inputs.pitch -= e.movementY * 0.002;
                Game.inputs.pitch = Math.max(-1.5, Math.min(1.5, Game.inputs.pitch));
            }
        });
        
        document.addEventListener('keydown', e => {
            if(e.code == 'KeyW') Game.inputs.w = 1;
            if(e.code == 'KeyS') Game.inputs.s = 1;
            if(e.code == 'KeyA') Game.inputs.a = 1;
            if(e.code == 'KeyD') Game.inputs.d = 1;
        });
        document.addEventListener('keyup', e => {
            if(e.code == 'KeyW') Game.inputs.w = 0;
            if(e.code == 'KeyS') Game.inputs.s = 0;
            if(e.code == 'KeyA') Game.inputs.a = 0;
            if(e.code == 'KeyD') Game.inputs.d = 0;
        });
        
        // Цикл
        Game.animate();
        setInterval(Game.sendMyPos, SETTINGS.syncRate);
    };
    
    // Добавить другого игрока на сцену
    Game.addPlayer = (id) => {
        if(Game.players[id]) return; // Уже есть
        
        const color = SETTINGS.colors[Object.keys(Game.players).length % SETTINGS.colors.length];
        
        // Тело "Аниме" персонажа (простая сборка)
        const group = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.5), new THREE.MeshBasicMaterial({color: color}));
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshBasicMaterial({color: 0xffddaa}));
        head.position.y = 1;
        
        group.add(body);
        group.add(head);
        
        Game.scene.add(group);
        Game.players[id] = group;
        document.getElementById('players-list').innerText = "Players: " + (Object.keys(Game.players).length + 1);
    };
    
    // Обновить позицию другого игрока
    Game.updatePlayerPos = (id, data) => {
        if(!Game.players[id]) Game.addPlayer(id);
        const p = Game.players[id];
        p.position.set(data.x, data.y, data.z);
        p.rotation.y = data.yaw;
    };
    
    Game.removePlayer = (id) => {
        if(Game.players[id]) {
            Game.scene.remove(Game.players[id]);
            delete Game.players[id];
        }
    };
    
    // Физика движения
    Game.animate = () => {
        requestAnimationFrame(Game.animate);
        
        // Движение
        const dir = new THREE.Vector3();
        dir.z = Game.inputs.w - Game.inputs.s;
        dir.x = Game.inputs.d - Game.inputs.a;
        dir.applyAxisAngle(new THREE.Vector3(0,1,0), Game.inputs.yaw);
        dir.normalize().multiplyScalar(SETTINGS.speed * 0.016);
        
        Game.myObj.x += dir.x;
        Game.myObj.z += dir.z; // -
        
        // Камера
        Game.camera.position.set(Game.myObj.x, Game.myObj.y, Game.myObj.z);
        Game.camera.rotation.set(Game.inputs.pitch, Game.inputs.yaw, 0, 'YXZ');
        
        Game.renderer.render(Game.scene, Game.camera);
    };

    // Отправка данных
    Game.sendMyPos = () => {
        if(!Game.isPlaying) return;
        
        const packet = {
            type: 'move', // если я клиент, я шлю 'move', хост поймет
            type: Game.isHost ? 'update' : 'move', 
            x: Game.myObj.x,
            y: Game.myObj.y,
            z: Game.myObj.z,
            yaw: Game.inputs.yaw
        };

        if (Game.isHost) {
            // Хост обновляет всех
             packet.type = 'update';
             packet.id = Game.myId; // Пометка "Это данные Хоста"
             // Рассылаем всем
             for(let cid in Game.clients) { Game.clients[cid].send(packet); }
        } else {
            // Клиент шлет только Хосту
            if(Game.hostConn && Game.hostConn.open) {
                packet.type = 'move';
                Game.hostConn.send(packet);
            }
        }
    };
</script>
</body>
</html>
