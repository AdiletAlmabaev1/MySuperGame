<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Battle Multi</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* CSS: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –°—Ç–∏–ª—å */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; overflow: hidden; background: #050505; color: #fff; 
            font-family: 'Orbitron', sans-serif; touch-action: none;
        }

        .screen {
            position: absolute; width: 100%; height: 100%; background: #050505;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10; transition: opacity 0.5s;
        }
        .hidden { display: none !important; }

        h1 { font-size: 2.5rem; text-shadow: 0 0 20px #0ff; margin-bottom: 40px; text-align: center; }
        
        button {
            background: linear-gradient(45deg, #00f, #f0f); border: none; padding: 20px 40px;
            font-family: 'Orbitron', sans-serif; color: white; font-size: 1.2rem;
            margin: 10px; border-radius: 5px; box-shadow: 0 0 15px #00f; cursor: pointer;
            width: 80%; max-width: 300px; text-transform: uppercase;
        }
        button:active { transform: scale(0.95); box-shadow: 0 0 5px #00f; }
        input { 
            padding: 15px; font-size: 1.2rem; background: #111; border: 1px solid #0ff; 
            color: #0ff; text-align: center; width: 80%; margin-bottom: 20px; font-family: 'Orbitron';
        }

        /* –ò–ì–†–û–í–û–ô UI */
        canvas { display: block; }
        
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        }
        .top-bar {
            display: flex; justify-content: space-between; padding: 15px; 
            font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px #000;
        }
        
        /* –°—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –®—É—Ç–µ—Ä–∞) */
        #sticks-layer { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 30px; }
        .stick-zone { width: 100px; height: 100px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 50%; position: relative; pointer-events: auto; }
        .stick-knob { width: 40px; height: 40px; background: rgba(0,255,255,0.5); border-radius: 50%; position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Clash) */
        #cards-layer {
            position: absolute; bottom: 10px; width: 100%; display: flex; 
            justify-content: center; pointer-events: auto; gap: 10px;
        }
        .card-btn {
            width: 70px; height: 90px; background: #222; border: 2px solid #555; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-around;
            cursor: pointer; position: relative; pointer-events: auto;
        }
        .card-btn.ready { border-color: #0f0; box-shadow: 0 0 10px #0f0; background: #002200; }
        .card-cost { position: absolute; top:-10px; right:-10px; background: #a0f; border-radius: 50%; width: 25px; height: 25px; display:flex; justify-content:center; align-items:center; font-size: 0.8rem; }
        .elixir-bar-bg {
            position: absolute; bottom: 110px; left: 10%; width: 80%; height: 10px; background: #333; border:1px solid white;
        }
        .elixir-fill { height: 100%; background: #d0f; width: 0%; transition: width 0.2s; }
        
    </style>
</head>
<body>

    <!-- –ú–µ–Ω—é -->
    <div id="screen-menu" class="screen">
        <h1>NEON VERSUS</h1>
        <button onclick="Game.startHost()">‚ö° HOST GAME</button>
        <button onclick="UI.show('screen-lobby')" style="background:linear-gradient(45deg,#444,#666)">üîó JOIN GAME</button>
    </div>

    <!-- –õ–æ–º–º–∏ -->
    <div id="screen-lobby" class="screen hidden">
        <h1>Connect</h1>
        <input type="text" id="joinId" placeholder="HOST ID">
        <button onclick="Game.joinGame()">GO</button>
        <button onclick="UI.show('screen-menu')" style="background:#333">Back</button>
    </div>

    <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (–•–æ—Å—Ç) -->
    <div id="screen-mode" class="screen hidden">
        <h1>Select Mode</h1>
        <button onclick="Game.selectMode('tanks')">üöú Neon Tanks</button>
        <button onclick="Game.selectMode('clash')">‚öîÔ∏è Cyber Clash</button>
        <div id="host-msg" style="color:#aaa; margin-top:20px; font-size:0.9rem">Wait for player 2...</div>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="screen-game" class="screen hidden">
        <canvas id="ctx"></canvas>
        <div id="hud">
            <div class="top-bar">
                <span style="color:#0ff">P1: <span id="score1">0</span></span>
                <span style="color:#f0f">P2: <span id="score2">0</span></span>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–∞–Ω–∫–æ–≤ -->
            <div id="sticks-layer" class="hidden">
                <div class="stick-zone" id="joyL"><div class="stick-knob"></div></div>
                <div class="stick-zone" id="joyR" style="border-color: rgba(255,0,255,0.2)"><div class="stick-knob" style="background:rgba(255,0,255,0.5)"></div></div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è Clash -->
            <div id="elixir-ui" class="hidden">
                <div class="elixir-bar-bg"><div class="elixir-fill" id="e-fill"></div></div>
            </div>
            <div id="cards-layer" class="hidden">
                <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è JS-–æ–º -->
            </div>
        </div>
    </div>

<script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
const COLORS = { p1: '#00ffff', p2: '#ff00ff', wall: '#ffffff', ground: '#111' };

const Game = {
    role: null, conn: null, peer: null, mode: null,
    width: 0, height: 0, 
    loopId: null,

    startHost: () => {
        Game.role = 'host';
        document.querySelector('button').innerText = 'Starting...';
        Game.peer = new Peer();
        Game.peer.on('open', id => {
            UI.show('screen-mode');
            document.getElementById('host-msg').innerHTML = `Send ID to friend: <b style="color:#fff;font-size:1.5rem">${id}</b>`;
        });
        Game.peer.on('connection', c => {
            Game.conn = c;
            Game.setupConn();
            alert("Player 2 connected! Select mode.");
        });
    },

    joinGame: () => {
        const id = document.getElementById('joinId').value;
        if(!id) return alert("Enter ID");
        Game.role = 'client';
        Game.peer = new Peer();
        Game.peer.on('open', myId => {
            Game.conn = Game.peer.connect(id);
            Game.setupConn();
        });
    },

    setupConn: () => {
        Game.conn.on('data', d => {
            if(d.type === 'START') Game.initGame(d.mode);
            if(d.type === 'WORLD') { Renderer.state = d.state; if(Game.role==='client') Renderer.draw(); }
            if(d.type === 'INPUT' && Game.role==='host') Logic.p2Input = d.input;
        });
    },

    selectMode: (m) => {
        if(!Game.conn) return alert("Wait for P2");
        Game.conn.send({type:'START', mode:m});
        Game.initGame(m);
    },

    initGame: (m) => {
        Game.mode = m;
        UI.show('screen-game');
        
        // Setup Canvas
        const c = document.getElementById('ctx');
        Game.width = window.innerWidth;
        Game.height = window.innerHeight;
        c.width = Game.width; c.height = Game.height;

        // UI Setup
        document.getElementById('sticks-layer').classList.toggle('hidden', m !== 'tanks');
        document.getElementById('cards-layer').classList.toggle('hidden', m !== 'clash');
        document.getElementById('elixir-ui').classList.toggle('hidden', m !== 'clash');
        
        if(m === 'clash') ClashLogic.initUI();

        // Initial State
        Logic.reset();
        if(Game.role === 'host') Game.loop();
    },

    loop: () => {
        Logic.update();
        Game.conn.send({type:'WORLD', state: Logic.state});
        Renderer.state = Logic.state; 
        Renderer.draw();
        Game.loopId = requestAnimationFrame(Game.loop);
    }
};

// --- –§–ò–ó–ò–ö–ê –ò –õ–û–ì–ò–ö–ê ---
const Logic = {
    state: {},
    p1Input: {x:0, y:0, aimX:0, aimY:0, shoot:false, spawn: null},
    p2Input: {x:0, y:0, aimX:0, aimY:0, shoot:false, spawn: null},
    
    reset: () => {
        Logic.state = {
            tanks: [
                {x: 100, y: Game.height/2, hp:100, cd:0, score:0}, // P1
                {x: Game.width-100, y: Game.height/2, hp:100, cd:0, score:0} // P2
            ],
            bullets: [],
            walls: [], // Walls for tanks
            units: [], // For Clash
            elixir: { p1: 0, p2: 0 },
            mode: Game.mode,
            time: 0
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–µ–Ω –¥–ª—è –¢–∞–Ω–∫–æ–≤
        if(Game.mode === 'tanks') {
            const wc = 5, hr = 5; 
            const sx = Game.width/wc, sy = Game.height/hr;
            for(let i=0; i<8; i++) {
                Logic.state.walls.push({
                    x: Math.floor(1 + Math.random()*(wc-2))*sx, 
                    y: Math.floor(Math.random()*hr)*sy,
                    w: 20, h: 100
                });
            }
        }
    },

    update: () => {
        Logic.state.time++;
        if(Logic.state.mode === 'tanks') TanksLogic.tick();
        else ClashLogic.tick();
    }
};

const TanksLogic = {
    tick: () => {
        const s = Logic.state;
        const speed = 4;
        
        // P1 Move
        const p1 = s.tanks[0];
        const i1 = Logic.p1Input;
        p1.x += i1.x * speed; p1.y += i1.y * speed;
        // P2 Move
        const p2 = s.tanks[1];
        const i2 = Logic.p2Input;
        p2.x += i2.x * speed; p2.y += i2.y * speed;

        // Boundaries & Collision with walls
        [p1, p2].forEach(p => {
            if(p.x<0) p.x=0; if(p.x>Game.width) p.x=Game.width;
            if(p.y<0) p.y=0; if(p.y>Game.height) p.y=Game.height;
        });

        // Shooting
        if(i1.shoot && p1.cd <= 0) { s.bullets.push({x:p1.x, y:p1.y, vx:i1.aimX*15, vy:i1.aimY*15, o:0}); p1.cd = 20; }
        if(i2.shoot && p2.cd <= 0) { s.bullets.push({x:p2.x, y:p2.y, vx:i2.aimX*15, vy:i2.aimY*15, o:1}); p2.cd = 20; }
        if(p1.cd>0) p1.cd--; if(p2.cd>0) p2.cd--;

        // Bullets Physics
        for(let i=s.bullets.length-1; i>=0; i--) {
            let b = s.bullets[i];
            b.x += b.vx; b.y += b.vy;
            
            // Hit Enemy
            let enemyIdx = b.o === 0 ? 1 : 0;
            let enemy = s.tanks[enemyIdx];
            let dist = Math.hypot(b.x-enemy.x, b.y-enemy.y);
            
            // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç–µ–Ω–∞ (–æ—Ç—Å–∫–æ–∫)
            s.walls.forEach(w => {
                 if(b.x>w.x && b.x<w.x+w.w && b.y>w.y && b.y<w.y+w.h) {
                     s.bullets.splice(i,1); // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º
                 }
            });

            if(dist < 30) {
                s.tanks[b.o].score++;
                enemy.x = enemyIdx===0? 100 : Game.width-100; // Respawn
                enemy.y = Math.random()*Game.height;
                s.bullets.splice(i,1);
            } else if (b.x<0||b.x>Game.width||b.y<0||b.y>Game.height) {
                s.bullets.splice(i,1);
            }
        }
    }
};

const ClashLogic = {
    cards: [
        {name: 'Tank', hp: 200, dmg: 10, speed: 2, cost: 3, color: '#faa'},
        {name: 'Runner', hp: 50, dmg: 20, speed: 6, cost: 2, color: '#afa'},
    ],
    initUI: () => {
        const con = document.getElementById('cards-layer');
        con.innerHTML = '';
        ClashLogic.cards.forEach((c, idx) => {
            let b = document.createElement('div');
            b.className = 'card-btn';
            b.innerHTML = `<span class="card-cost">${c.cost}</span><div>${c.name}</div>`;
            b.onclick = () => { Logic.p1Input.spawn = idx; };
            con.appendChild(b);
        });
    },
    tick: () => {
        const s = Logic.state;
        
        // 1. Elixir Generation (every 1s)
        if(s.time % 60 === 0) {
            if(s.elixir.p1 < 10) s.elixir.p1++;
            if(s.elixir.p2 < 10) s.elixir.p2++;
        }

        // 2. Spawning (Handle inputs)
        [ {inp: Logic.p1Input, owner: 0}, {inp: Logic.p2Input, owner: 1} ].forEach(obj => {
            if(obj.inp.spawn !== null) {
                let card = ClashLogic.cards[obj.inp.spawn];
                let eli = obj.owner===0 ? s.elixir.p1 : s.elixir.p2;
                if(eli >= card.cost) {
                    // Create unit
                    s.units.push({
                        x: obj.owner===0 ? 50 : Game.width-50,
                        y: 100 + Math.random()*(Game.height-200),
                        hp: card.hp, maxHp: card.hp, dmg: card.dmg, speed: card.speed,
                        owner: obj.owner,
                        r: 15
                    });
                    if(obj.owner===0) s.elixir.p1 -= card.cost; else s.elixir.p2 -= card.cost;
                }
                obj.inp.spawn = null; // Reset input
            }
        });

        // 3. Move & Combat
        for(let i=s.units.length-1; i>=0; i--) {
            let u = s.units[i];
            
            // –ù–∞–π—Ç–∏ –≤—Ä–∞–≥–∞
            let target = null;
            let minDist = 150; 
            
            s.units.forEach(other => {
                if(other.owner !== u.owner) {
                    let d = Math.hypot(u.x-other.x, u.y-other.y);
                    if(d < minDist) { minDist=d; target=other; }
                }
            });

            if(target && minDist < 30) {
                // –ê—Ç–∞–∫–∞
                target.hp -= 1; // –£—Ä–æ–Ω –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä (–ø—Ä–æ—Å—Ç–æ –¥–ª—è –¥–µ–º–æ)
            } else {
                // –î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥ –∏–ª–∏ –∫ –≤—Ä–∞–≥—É
                if(target) {
                    let angle = Math.atan2(target.y - u.y, target.x - u.x);
                    u.x += Math.cos(angle)*u.speed*0.5;
                    u.y += Math.sin(angle)*u.speed*0.5;
                } else {
                    u.x += (u.owner===0 ? 1 : -1) * u.speed * 0.5;
                }
            }
            
            // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ - –æ—á–∫–æ –∏ —Å–º–µ—Ä—Ç—å
            if((u.owner===0 && u.x > Game.width) || (u.owner===1 && u.x < 0)) {
                if(u.owner===0) s.tanks[0].score++; else s.tanks[1].score++;
                u.hp = -100;
            }

            if(u.hp <= 0) s.units.splice(i,1);
        }
    }
};

// --- –û–¢–†–ò–°–û–í–ö–ê ---
const Renderer = {
    state: null,
    draw: () => {
        const s = Renderer.state;
        if(!s) return;
        const ctx = document.getElementById('ctx').getContext('2d');
        const W = Game.width, H = Game.height;

        // –§–æ–Ω
        ctx.fillStyle = '#050505'; ctx.fillRect(0,0,W,H);
        
        if(s.mode === 'tanks') {
            // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—ã
            ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; ctx.fillStyle = '#fff';
            s.walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // –†–∏—Å—É–µ–º –ø—É–ª–∏
            ctx.fillStyle = '#ffaa00'; ctx.shadowColor = '#fa0';
            s.bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, Math.PI*2); ctx.fill(); });

            // –†–∏—Å—É–µ–º —Ç–∞–Ω—á–∏–∫–∏
            Renderer.drawTank(ctx, s.tanks[0], COLORS.p1);
            Renderer.drawTank(ctx, s.tanks[1], COLORS.p2);
            
            ctx.shadowBlur = 0; // –°–±—Ä–æ—Å
        }
        else if(s.mode === 'clash') {
            // –≠–ª–∏–∫—Å–∏—Ä UI Update
            const p1El = Game.role==='host' ? s.elixir.p1 : s.elixir.p2;
            const bar = document.getElementById('e-fill');
            if(bar) bar.style.width = (p1El * 10) + '%';
            
            // –¶–µ–Ω—Ç—Ä –ª–∏–Ω–∏—è
            ctx.strokeStyle='#333'; ctx.beginPath(); ctx.moveTo(W/2,0); ctx.lineTo(W/2,H); ctx.stroke();

            // –Æ–Ω–∏—Ç—ã
            s.units.forEach(u => {
                ctx.shadowBlur = 15;
                ctx.shadowColor = u.owner===0 ? COLORS.p1 : COLORS.p2;
                ctx.fillStyle = u.owner===0 ? COLORS.p1 : COLORS.p2;
                
                // –ó–¥–æ—Ä–æ–≤—å–µ
                let scale = u.hp / u.maxHp;
                ctx.globalAlpha = 0.5 + 0.5*scale; 
                ctx.beginPath(); ctx.arc(u.x, u.y, 15 * scale, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            });
            ctx.shadowBlur = 0;
        }
        
        document.getElementById('score1').innerText = s.tanks[0].score;
        document.getElementById('score2').innerText = s.tanks[1].score;
    },

    drawTank: (ctx, t, color) => {
        ctx.shadowBlur = 20; ctx.shadowColor = color; ctx.fillStyle = color;
        // –ö–æ—Ä–ø—É—Å
        ctx.fillRect(t.x-20, t.y-20, 40, 40);
        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–æ) - –ø—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º –∫–æ–ª—å—Ü–æ
        ctx.strokeStyle = '#fff'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.arc(t.x, t.y, 10, 0, Math.PI*2); ctx.stroke();
    }
};

// --- INPUTS ---
// Virtual Joysticks
function setupJoy(id, cb) {
    const el = document.getElementById(id);
    let start = {x:0, y:0};
    const move = (cx, cy) => {
        let dx = cx - start.x, dy = cy - start.y;
        let dist = Math.min(Math.hypot(dx,dy), 50);
        let ang = Math.atan2(dy,dx);
        let nx = Math.cos(ang)*dist, ny = Math.sin(ang)*dist;
        el.querySelector('.stick-knob').style.transform = `translate(calc(-50% + ${nx}px), calc(-50% + ${ny}px))`;
        cb(nx/50, ny/50);
    };
    el.addEventListener('touchstart', e=>{ start={x:e.touches[0].clientX - 50, y:e.touches[0].clientY - 50}; // hack center
        start = {x: el.getBoundingClientRect().left+50, y:el.getBoundingClientRect().top+50};
        move(e.touches[0].clientX, e.touches[0].clientY);
    });
    el.addEventListener('touchmove', e=>{ e.preventDefault(); move(e.touches[0].clientX, e.touches[0].clientY); });
    el.addEventListener('touchend', ()=>{ el.querySelector('.stick-knob').style.transform='translate(-50%,-50%)'; cb(0,0); });
}

setupJoy('joyL', (x,y) => { Logic.p1Input.x = x; Logic.p1Input.y = y; sendInp(); });
setupJoy('joyR', (x,y) => { Logic.p1Input.aimX=x; Logic.p1Input.aimY=y; Logic.p1Input.shoot=(Math.abs(x)>.2||Math.abs(y)>.2); sendInp(); });

function sendInp() {
    if(Game.role === 'client' && Game.conn) {
        // –ö–æ—Å—Ç—ã–ª—å: –µ—Å–ª–∏ —è –∫–ª–∏–µ–Ω—Ç, —è —à–ª—é p1Input –∫–∞–∫ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, –∞ —Ö–æ—Å—Ç –ø–æ–π–º–µ—Ç, —á—Ç–æ —ç—Ç–æ –¥–ª—è p2
        Game.conn.send({type:'INPUT', input: Logic.p1Input}); 
    }
}
</script>
</body>
</html>
